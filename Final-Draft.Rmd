---
title: "Predicting Which States are Most Interested in the term *China Virus* Based off Identity Politics, Demography and COVID-19 Statistics "
author: "Federico Chung, Will Madairy, Sofia Pozsonyiova, Quinn Rafferty"
date: 'May 8,2020'
output:
  html_document:
    toc: true
    toc_float: true
---

```{r, warning=FALSE, include=FALSE, message=FALSE}
library(dplyr)
library(usmap)
library(maps)
library(ggplot2)
library(tidyverse)
library(ggmap)
library(viridis)
library(rgdal)
library(gridExtra)
library(plotly)
library(janitor)
library(reshape2)
library(tidyr)
library(rstan)
library(rstanarm)
library(bayesplot)
library(sf)
library(remotes)
```

```{r, include=FALSE, warning=FALSE}
prediction_summary_data <- function(y, yrep, prob_inner = 0.5, prob_outer = 0.95){
  # Calculate summary statistics of simulated 
  # posterior predictive models for each case
  l_outer <- function(x){quantile(x, (1-prob_outer) / 2)}
  l_inner <- function(x){quantile(x, (1-prob_inner) / 2)}
  u_inner <- function(x){quantile(x, 1 - (1-prob_inner) / 2)}
  u_outer <- function(x){quantile(x, 1 - (1-prob_outer) / 2)}
  df <- data.frame(yrep) %>% 
    summarize_all(list(mean, sd, median, mad, l_outer, l_inner, u_inner, u_outer)) %>%
    unlist() %>% 
    matrix(., length(y), 8) %>% 
    data.frame()
  names(df) <- c("post_mean", "post_sd", "post_median", "post_mad", "l_outer", "l_inner", "u_inner", "u_outer")
  data.frame(cbind(y, df))
}


prediction_summary <- function(y, yrep, prob_inner = 0.5, prob_outer = 0.95){
  # This function summarizes the predictions across all cases
  pred_data <- prediction_summary_data(y, yrep, prob_inner = prob_inner, prob_outer = prob_outer) %>% 
    mutate(error = y - post_median) %>% 
    mutate(error_scaled = error / post_mad) %>% 
    mutate(within_inner = (y >= l_inner) & (y <= u_inner)) %>% 
    mutate(within_outer = (y >= l_outer) & (y <= u_outer))
  
  
  pred_summary <- pred_data %>% 
    summarize(mae = median(abs(error)), 
      mae_scaled = median(abs(error_scaled)),
      within_inner = mean(within_inner),
      within_outer = mean(within_outer)
    )
  names(pred_summary)[3] <- paste0("within_", prob_inner*100)
  names(pred_summary)[4] <- paste0("within_", prob_outer*100)
  
  pred_summary
}
```


# 1. Introduction

On March 17, 2020 President Trump referred to the Coronavirus as the "China Virus." Shortly after, the number of anti-Chinese incidents started to increase across the United States. One aspect of public health that is often thrown to the wayside is how influential public officials and leaders are in disseminating public health information. Moreover, not only can their words change the public's views on a health matter but it can also shift a nation's perspective on someone's identity. _[ADD SOME BACKGROUND LITERATURE THAT BACKS THIS CLAIM UP]_ In addition, given the influence of identity politics we may expect the term "China Virus" to be more polarizing to certain identities and states. _[ADD BACKGROUND LITERATURE + IDENTIFY SUBJECTS OF INTEREST]_. There are fewer studies devoted to analyzing these aspects of the pandemic. 


Thus,our project aims to explore the relationship and variability of interest in the term "China Virus" across states through  political, demographic and COVID-19 characteristics. We ask the question, _[INSERT OUR RESERACH QUESTION]_ ?  In order to answer this question, we look to gain a better understanding of _[INSERT NAME OF BAYESIAN METHODOLOGY]_. Ultimately, we hope our research inspires others to explore and better understand the impact langauge and words have on the public during times of crisis. 

\



# 2. Data
```{r}

Finaldata<-read_csv("time_series_final_Data.csv")
google<-read.csv("Google/googlefinal.csv")

Finaldata <- Finaldata %>% mutate(Day= as.Date(Day, tryFormats = "%m/%d/%Y"))

day_initial<- as.Date("03/14/2020",tryFormats = "%m/%d/%Y")
day_final<- as.Date("03/21/2020",tryFormats = "%m/%d/%Y")


Finaldata<- Finaldata%>%
  filter(Day>=day_initial)%>%
  filter(Day<=day_final)

```

## 2.1 Data Descriptions

## 2.2 Variables of interest

## 2.3 Visualizations _NEED TO WEAVE A COHEASIVE MESSAGE BETWEEN THESE VISUALIZATIONS TO TELL A STORY _

### 2.3a Demographic 

```{r}
Finaldata$hover <- with(Finaldata, paste(State, '<br>', "Positive Cases:", positive, "<br>","Positive Negative:", negative,"<br>",
                           "Total Cases:", totalTestResults,"<br>", "% White:", percent_white,"<br>",
                            "% Asian:", percent_asian, "<br>", "State Color:", StateColor))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

fig <- plot_geo(Finaldata, locationmode = 'USA-states')
fig <- fig %>% add_trace(
    z = ~ChinaVirusInterest, text = ~hover, locations = ~State,
    color = ~ChinaVirusInterest, colors = 'Purples'
  )
fig <- fig %>% colorbar(title = "Interest")
fig <- fig %>% layout(
    title = '2020 COVID-19 Cases, Demographics, & Politics by State<br>(Hover for breakdown)', geo=g
  )

fig
```

```{r, warning=FALSE, message= FALSE, echo=FALSE}
#Demographic: Identification 
Finaldata <- data.frame(Finaldata) %>% mutate(state = State)

plot_usmap(data = Finaldata, values = "percent_white", color = "white") + 
  scale_fill_continuous(name = "Percent White", label = scales::comma) + 
  theme(legend.position = "right")+ ggtitle("Percent of Residents that Identify as White") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_viridis_c(option = "plasma") + theme(plot.title = element_text(size=11))+ labs(fill = "% White")
p1


p2<- plot_usmap(data = Finaldata, values = "percent_asian", color = "white") + 
  scale_fill_continuous(name = "Percent Asian", label = scales::comma) + 
  theme(legend.position = "right")+ ggtitle("Percent of Residents that Identify as Asian") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_viridis_c(option = "plasma") + theme(plot.title = element_text(size=11))+ labs(fill = "% Asian")


```

Our first visualization is looking at the percent of residents that identify as white within the United States compared to those whom identify as asian. As you can see, there is a higher percent of white identifying residents overall but most specifically in the Midwest and northeast states. In regards to Asian-Americans, there is practically less than .1% per state with the exception of California and New York. From this visualization we can also see that places like Texas, California, and New Mexico have much lower white identifying residents which could provide important information for us in our actual analysis. 

### 2.3b Google China Virus

```{r, warning=FALSE, message= FALSE, echo=FALSE}
e <- Finaldata%>%
  ggplot(aes(x = ChinaVirusInterest))+
  geom_density()

ggplotly(e)
```

During the 2020-03-14 - 2020-03-21 week, Trump in an official press announcement labeled the Corona Virus as "China Virus" and we wanted to see how his comments affected search patterns across states.

As we can see from the density plot of the China Virus Interest during our time period 2020-03-14 - 2020-03-21, it behaves relatively normal with a small bump at 0. As a group we believe this bump occurs as 0 is the lowest value it can take and because of that limitation of the China Virus Interest we see a small bump around 0. One could argue against a normal distribution as it kinda looks a bit right skewed. But our team believes that a normal distribution is the best at describing the density.  

When China Virus Interest equals 0 it means that no one in the state looked up the term in Google and this is prevalent at the 14 of March where there are 5 occurrences and the 21 of March where there are 4 occurrences. And in states such as DC, ND, SD, and VT.

```{r, warning=FALSE, message= FALSE, echo=FALSE}
Trump<- as.Date("03/16/2020", format = "%m/%d/%Y")
day1<-as.Date("03/10/2020",format = "%m/%d/%Y")
day2<-as.Date("03/24/2020",format = "%m/%d/%Y")

google_ts<-google%>%
  mutate(Day = as.Date(as.character(Day)))

a<-google_ts %>% 
  #filter(Day<=day2)%>%
  #filter(Day>=day1)%>%
  group_by(Region, Day) %>% 
  summarize(ChinaVirusSearch = median(ChinaVirusInterest)) %>% 
  ggplot(aes(x=Day, y=ChinaVirusSearch, color=Region))+
  geom_point()

ggplotly(a)
```
This plot shows the relationship of “China Virus” search interest over grouped by region. This plots shows that there are certainly key events that trigger an uptick in searches overall. In this plot it is not clear which region may search China Virus more or less often, but it does show a that the regions move together in search interest, which would imply federal level events like a Donald Trump tweet to trigger these interest spikes. 

```{r, warning=FALSE, message= FALSE, echo=FALSE}
b<- ggplot(Finaldata, aes(x = ChinaVirusInterest, fill = as.factor(State))) + 
  geom_density(alpha = 0.5)+ ggtitle("China Virus Density by State")

ggplotly(b)
```

We can see that the variability in Google interest in the term China Virus is has quite a large range between states. There are very few states that have high densities among the upper echelons of the interest scale but there are some interesting peaks of densities among the lower values. For example, we can see that Alaska, Wyoming and Iowa have unusual peaks around the 25-50 range. It is is also interesting interesting to note that there isn't an *obvious* mean or median value of China Virus interest among the states. 

### 2.3c COVID-19

```{r, warning=FALSE, message= FALSE, echo=FALSE}
c <-  ggplot(Finaldata, aes(y=positive, x=Winner, fill=(Winner)))+
      geom_boxplot() +
      facet_wrap(~Region)+
      theme(legend.position = "none") +
      scale_fill_manual(values = c("Democrat"="blue3", "Republican"= "red3"))+
      lims(y= c(0,1000))+
      ggtitle("Positive COVID-19 Cases by State Political Party Winner & Region")
```

```{r, warning=FALSE}
ggplotly(c)
```
This visualisation depicts the distribution of positive COVID-19 cases by region and by which political party won in the 2016 elections. We can see that Democrat states in the Midwest, Mountain, and West have a larger range and higher quantile metrics for positive cases overall. For the Northeast and South regions the mean of positive COVID-19 cases are higher but not significantly. This is an interesting pattern considering that poltical party affiliation appears to interact with the number of postive cases by region. 


\
\



# 3. Methods & Models (Feddy and Will)

## 3.1 Markov Chain Algorithm 

## 3.2 Models of Interest

## 3.3 Model Descriptions

\
\


# 4. Model Evaluation

## 4.1 Model 1 Evaluation( Repeated measures)

## 4.2 Model 2 Evaluation (Normal Regression)

## 4.3 Model 3 Evaluation(Repeated Reg + Normal)

## 4.4 Model 4 Evaluation (Longitudinal)


\
\



# 5. Results (Will)

## 5.1 Posterior Predctions All States 

### 5.1.a Table 

## 5.2 Posterior Prediction One State

## 5.3 Final Model 


\
\


# 6.Conclusion 

## 6.1 Limitations

## 6.2 Future Work

\
\


# 7. Acknowledgments and References 













