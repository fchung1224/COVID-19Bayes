---
title: "Checkpoint 3"
author: "Quinn Rafferty, Sofia Pozsonyiova, Will Madairy, Federico Chung"
date: "4/24/2020"
output: 
  html_document:
    toc: true
    toc_float: true
---

\
\


#Libraries 

```{r, warning=FALSE}
library(dplyr)
library(usmap)
library(maps)
library(ggplot2)
library(tidyverse)
library(ggmap)
library(viridis)
library(rgdal)
library(gridExtra)

require(janitor)
require(reshape2)
require(tidyr)
require(rstan)
require(rstanarm)
require(bayesplot)
```



\
\




# Data
```{r}
Finaldata<- read.csv("time_series_final_Data.csv")
```

```{r}
google<-read.csv("Google/googlefinal.csv")
```

Re-Cleaned 
```{r}
Finaldata <- Finaldata %>% select(-c(X)) 
Finaldata <- Finaldata %>% mutate(Day = as.Date(as.character(Day)))
```



##Dataset Description 

`Demographic:`
Our dataset, `Demographic`, was created by merging three other datasets which all contained different demographic and election information. We obtained the main portion of our demographic data from the US Census Bureau’s American Community Survey (ACS) which is an ongoing survey administered by the U.S. Census Bureau. It  gathers information on income, employment, housing characteristics, etc, annually for all the 50 U.S. States on the county and state level. To access the county-level dataset we used the R package called Choroplethr which provides API connections to data sources like the ACS. The ACS County-Level dataset was then merged with a county-level election outcome dataset that was created by Tony McGoven. Tony’s dataset contained presidential election results for 2008,2012, and 2016 but we chose to focus solely on the most recent election,2016. That said, the 2016 election results at the county-level were scraped from results published by Townhall.com. However, the State of Alaska reports results at the precinct or state level so there was no county-level data available. Therefore, another dataset had to be created that contained the election results for Alaska and this was done using the official election results provided by the Alaska Division of Elections and was later merged in. The final dataset that was used came from Alicia Johnson and it contained information on a state’s political leaning. Meaning it categorizes each county as belonging to a blue/red/purple state based on the state categorizations at 279towin. 

`COVID-19 Cases`
The COVID-19 data is provided by The COVID Tracking Project(CTP). All of the  data points come from state/district/territory public health authorities—or, occasionally, from trusted news reporting, official press conferences, or (very occasionally) tweets or Facebook updates from state public health authorities or governors. These numbers are updated daily at 4PM EST. The biggest weakness of this dataset is that there is no standardized methods for states to follow for data collection/report. For example, some states, like Oregon, provide the **full** set of numbers but others provide some or none of these numbers on an ongoing basis. Some crucial states in this outbreak, notably California, Washington, and New York, have not been regularly reporting their total number of people tested. The CTP aims to remedy this uncertainty in states by utilizing other reporting/measuring tools such as: "Directly asking state officials, watching news conferences, gleaning information from trusted news sources, and whatever else it takes to present reliable numbers." 

##Dataset Details 
```{r}
dim(Finaldata)

names(Finaldata)

head(Finaldata)

summary(Finaldata)

colnames(Finaldata)
```

##Variables of Interest

+------------------------+---------------------------------------------------+
| Variables:             | Description:                                      |
+========================+===================================================+
| `polyname`             | State Name                                        |
|                        |                                                   | 
+------------------------+---------------------------------------------------+
| `StateColor`           | Political Leaning                                 |
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`percent_hispanic`      | Percent of the Population that is Hispanic        |
|                        |                                                   | 
+------------------------+---------------------------------------------------+
| `percent_white`        | Percent of the Population that is White           |
|                        |                                                   | 
+------------------------+---------------------------------------------------+
| `percent_asian`        | Percent of the Population that is Asian           |  
|                        |                                                   | 
+------------------------+---------------------------------------------------+
| `percent_black`        | Percent of Population that is Black               |  
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`total_population`      | Total State Population                            | 
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`per_capita_income`     | Income per Capita                                 |
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`percent_democrat2016`  | Percent of votes won by Democrat (Clinton)        |  
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`percent_republican2016`| Percent of votes won by Republican (Trump)        | 
|                        |                                                   | 
+------------------------+---------------------------------------------------+
| `Winner`               | Indicator for whether a Republican or Democrat Won| 
|                        |                                                   |  
+------------------------+---------------------------------------------------+
|`total_2016`            | Total Number of Votes                             | 
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`Positive`              | Number of reported positive COVID-19 cases        | 
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`Negative`              | Number of reported negative COVID-19 cases        | 
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`date`                  | Date of report                                    | 
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`death`                 | Total Number of reported deaths due to COVID-19   | 
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`hospitalized`          | Total Number of indivudals hopitalized due        |
|                        | to COVID-19                                       |
+------------------------+---------------------------------------------------+
|`totalTestResults`      | Total Number test results (Positive +Negative)    | 
|                        |                                                   | 
+------------------------+---------------------------------------------------+
|`FIPS`                  | A five-digit Federal Information Processing       |
|                        | Standards code which uniquely identified counties |
|                        | and county                                        | 
+------------------------+---------------------------------------------------+
|`KungFluInterest`       | Interest index from google searches by state.     |
|                        | Peak search day=100, all other days in set are    |
|                        | based searches on relative to this peak day.      | 
+------------------------+---------------------------------------------------+
|`ChinaVirusInterest`    | Interest index from google searches by state.     |
|                        | Peak search day=100, all other days in set are    |
|                        | based searches on relative to this peak day.      | 
+------------------------+---------------------------------------------------+


##Visualizations 
```{r echo=FALSE}
google %>% 
  group_by(Region, Day) %>% 
  summarize(ChinaVirusSearch = median(ChinaVirusInterest)) %>% 
  ggplot(aes(x=Day, y=ChinaVirusSearch, color=Region))+
  geom_point()
```


### Demographic 
```{r}
#Demographic: Identification 
Finaldata <- data.frame(Finaldata) %>% mutate(state = State)
plot_usmap(data = Finaldata, values = "percent_white", color = "white") + 
  scale_fill_continuous(name = "Percent White", label = scales::comma) + 
  theme(legend.position = "right")+ ggtitle("Percent of Residents that Identify as White") + 
  theme(
plot.title = element_text(color="Black", size=14, face="bold")
)

plot_usmap(data = Finaldata, values = "percent_asian", color = "white") + 
  scale_fill_continuous(low = "sky blue", high = "black", name = "Percent Asian", label = scales::comma) + 
  theme(legend.position = "right") + ggtitle("Percent of Residents that Identify as Asian") +
  theme(
plot.title = element_text(color="Black", size=14, face="bold")
) 

#By Results 
plot_usmap(data = Finaldata, values = "percent_asian", color = "white") + 
  scale_fill_continuous(low = "sky blue", high = "black", name = "Percent Asian", label = scales::comma) + 
  theme(legend.position = "right") + ggtitle("Percent Asian by General Election Results")+
  theme(
plot.title = element_text(color="Black", size=14, face="bold")
) + facet_wrap(~Winner)


#By income 
plot_usmap(data = Finaldata, values = "per_capita_income", color = "white") + 
  scale_fill_continuous(low = "sky blue", high = "black", name = "$ Per Capita", label = scales::comma) + 
  theme(legend.position = "right") + ggtitle("Percent Capita Income")+
  theme(
plot.title = element_text(color="Black", size=14, face="bold")
) 

#Income by state affiliation 
ggplot(Finaldata, aes(x = per_capita_income, fill = StateColor)) + 
    geom_density(alpha = .8)+ ggtitle("Income per Capita") + xlab("$") + ylab("Density")

#Trump Support 
ggplot(Finaldata, aes(x = percent_republican2016)) + 
    geom_density()+ ggtitle("Trump Support During the 2016 Elections") + xlab("Percent of Trump Support") + ylab("Density")

ggplot(Finaldata, aes(x = percent_asian, y = percent_republican2016, color = Winner)) + 
    scale_color_manual(values = c("blue","purple","red")) + 
    geom_point(alpha = 0.8) + geom_text(aes(label=ifelse(percent_asian>.2,as.character(state),"")),hjust=1.2,vjust=0)+ geom_text(aes(label=ifelse(percent_republican2016<.2,as.character(state),"")),hjust=-.1,vjust=0) + ggtitle("Percent of Asians and Trump Support by Election Outcome") + xlab("Percent Asian") + ylab("Trump Support")

ggplot(Finaldata, aes(x = per_capita_income)) + 
    geom_density()+ ggtitle("Per Capita Income") + xlab("Per Capita Income") + ylab("Density") + facet_wrap(~Winner)
```

### COVID-19 Cases 

```{r}
## Creating a df of just the cases the week before 3/17
day1<-as.Date("2020-03-17")
weekbefore <- Finaldata %>% filter(Day <= day1)

Finaldata %>% 
  filter(Day <= day1)

plot1<- plot_usmap(data = weekbefore, values = "positive", color = "white") + 
  scale_fill_continuous(name = "Cases", label = scales::comma) + 
  theme(legend.position = "right")+ ggtitle("# of COVID Cases Before 3/17") + 
  theme(
plot.title = element_text(color="Black", size=8)
)

## Creating a df of just the cases the week after 3/17
weekafter <- data.frame(Finaldata) %>% filter(Day >= as.Date("2020-03-17"))

plot2<-plot_usmap(data = weekafter, values = "positive", color = "white") + 
  scale_fill_continuous(name = "Cases", label = scales::comma) + 
  theme(legend.position = "right")+ ggtitle("# of COVID Cases After 3/17") + 
  theme(
plot.title = element_text(color="Black", size=5)
)

# The number of Positive Covid Cases, comparison before and after the China Virus announcement 
grid.arrange(plot1, plot2, ncol=2)
```

```{r}
# Positive COVID cases aggregated by party 
ggplot(Finaldata, aes(x = positive, fill = StateColor)) + 
    geom_density(alpha = .8)+ ggtitle("Positive COVID-19 Cases by State Party") + xlab("Cases") + ylab("Density")+xlim(0,500)
```

```{r}
## Positive COVID cases map before and after week 
library(statebins)
plot3<-statebins(state_data = weekbefore, state_col = "state",
                     text_color = "white", value_col = "positive",
                     brewer_pal="Spectral", font_size = 3,breaks =7,
                     legend_title="Week Before",
                 labels = c("0","1-5","5-10","10-20","20-30","30-40","50-100"))

### Drastic scale change, needs work for comparison sake
plot4<-statebins(state_data = weekafter, state_col = "state",
                     text_color = "white", value_col = "positive",
                     brewer_pal="Spectral", font_size = 3,breaks =6,
                     legend_title="Week After",labels = c("1-100", "100-500", "500-5000", "5000-15000", "15000-25000", "25000-35000"))

plot3
plot4
```

\
\



# Analysis 

```{r}
set.seed(84735)
test1 <- Finaldata %>% 
  select(mean_KungFluInterest, percent_republican2016, percent_asian, StateColor) %>%
  na.omit() %>% 
  sample_n(500)

names(test1) <- tolower(names(test1))

test1
```

```{r}
set.seed(454)
building_mod <- stan_glm(
  mean_kungfluinterest ~ percent_republican2016 + percent_asian +statecolor, 
  data = test1, 
  family = gaussian, 
  chains = 4, iter = 10000
)
```


```{r}
mcmc_trace(building_mod)
mcmc_dens_overlay(building_mod)
```

```{r}
pp_check(building_mod)

# Could build like the sleep study, 50 frames one for each state and how Google Trends changed over time, each state has its own trajectory
# Can we look at each state and how their interest changes over time and if that's related to how many cases are in the state 

#What's the trend in interest and how does it depend on cases? 
```

```{r}
summary_building_mod <- summary(building_mod)

head(as.data.frame(summary_building_mod),-2)
```


```{r, include=FALSE}
prediction_summary_data <- function(y, yrep, prob_inner = 0.5, prob_outer = 0.95){
  # Calculate summary statistics of simulated 
  # posterior predictive models for each case
  l_outer <- function(x){quantile(x, (1-prob_outer) / 2)}
  l_inner <- function(x){quantile(x, (1-prob_inner) / 2)}
  u_inner <- function(x){quantile(x, 1 - (1-prob_inner) / 2)}
  u_outer <- function(x){quantile(x, 1 - (1-prob_outer) / 2)}
  df <- data.frame(yrep) %>% 
    summarize_all(list(mean, sd, median, mad, l_outer, l_inner, u_inner, u_outer)) %>%
    unlist() %>% 
    matrix(., length(y), 8) %>% 
    data.frame()
  names(df) <- c("post_mean", "post_sd", "post_median", "post_mad", "l_outer", "l_inner", "u_inner", "u_outer")
  data.frame(cbind(y, df))
}


prediction_summary <- function(y, yrep, prob_inner = 0.5, prob_outer = 0.95){
  # This function summarizes the predictions across all cases
  pred_data <- prediction_summary_data(y, yrep, prob_inner = prob_inner, prob_outer = prob_outer) %>% 
    mutate(error = y - post_median) %>% 
    mutate(error_scaled = error / post_mad) %>% 
    mutate(within_inner = (y >= l_inner) & (y <= u_inner)) %>% 
    mutate(within_outer = (y >= l_outer) & (y <= u_outer))
  
  
  pred_summary <- pred_data %>% 
    summarize(mae = median(abs(error)), 
      mae_scaled = median(abs(error_scaled)),
      within_inner = mean(within_inner),
      within_outer = mean(within_outer)
    )
  names(pred_summary)[3] <- paste0("within_", prob_inner*100)
  names(pred_summary)[4] <- paste0("within_", prob_outer*100)
  
  pred_summary
}
```

```{r}
preds <- posterior_predict(building_mod,newdata = test1) # Ask Alicia 
prediction_summary(y = test1$mean_kungfluinterest, yprep = preds)

```

\
\



```{r}
library(plotly)
google_ts<-read.csv("Time_series_Google.csv")

day1<-as.Date("03/10/2020",format = "%m/%d/%Y")
day2<-as.Date("03/24/2020",format = "%m/%d/%Y")

google_ts_reg<-google_ts_reg%>%
  mutate(Day = as.Date(as.character(Day)))

a<-google_ts_reg %>% 
  #filter(Day<=day2)%>%
  #filter(Day>=day1)%>%
  group_by(Region, Day) %>% 
  summarize(ChinaVirusSearch = median(ChinaVirusInterest)) %>% 
  ggplot(aes(x=Day, y=ChinaVirusSearch, color=Region))+
  geom_point()

ggplotly(a)
```








